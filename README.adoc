= Reforum

== Goals

* Only one program needed (apart from Kratos), but can run multiple servers on same DB
* Kratos serves multiple websites with unified account
* [.line-through]Sea-ORM
* Data consistency in DB
* Sparse queries in DB
* Optimize later
* N+1 query is a _feature_, not a bug. Yes, reads might give some inconsistencies, but this is a non-issue for my goal. On the other hand, each transaction is much shorter.
* Writes are of course atomic

== Roadmap

* [ ] Version 0.9
** [x] Standalone authentication
*** [x] Login/logout/sessions
*** [ ] Registration/change password/recovery
** [x] Role based authorization
** [ ] CRUD
* [ ] Version 1.0
** [ ] Refactor types
** [ ] Refactor errors
** [ ] Unit testing
** [ ] Documentation
* [ ] Version 1.1
** [ ] HTML templates
** [ ] I18N
** [ ] Front page
** [ ] Pinned topics
* [ ] Version 1.2
** [ ] Finer-grained authorization
** [ ] Tags
** [ ] Search
** [ ] HTMX flow?
* [ ] Version 1.3
** [ ] Finer-grained moderation
* [ ] Version 2.0
** [ ] ORY Kratos
** [ ] Asciidoc

== User Story

=== Basic Interactions

=== Account Actions

* [ ] There is only one site administrator
* [ ] The user may wipe his/her account, deleting every topics/posts/replies from the database
** [ ] Optionally require moderator approval
** [ ] Moderators wiping their own account always require admin approval
** [ ] If user has been a moderator, this fact would persist in the `past_moderators` table
** [ ] Only the user himself/herself or the site administrator may wipe the account
** [ ] If the user has been a moderator and has modified others' content, the log persist as UID

=== Soft Deletion

* [ ] Topics and posts are never deleted from database, unless their authors' accounts are wiped
* [ ] Replies are actually deleted

=== Authentication

=== Authorization

=== Moderation

=== Administration

* [ ] Good tracing
** [x] Log all requests and response codes
** [x] Latency traces
* [ ] Rate limiting
** [ ] Intervals between posts
** [ ] Intervals between views

== Experience Report

=== Sea-ORM

* The migrations are quite unreadable
* The manual entity generation step is suboptimal
** I would prefer to generate migrations _from_ entities, not the other way around
* The automatic generation for SQLite gives wrong types
** `i32` instead of `i64`
** `String` instead of `DateTimeUtc`
** `INSERT ON CONFLICT` not supported for sqlite
* Sea-Query statements generally very verbose and hard to read, and I cannot set it up stand-alone with rusqlite

=== SQLite

* Rusqlite does not support async
* Deadpool for pooling has some... issues
** In-memory db is probably not shared
** Unlike `sqlx`, there cannot be async transactions
** `InteractError` is a bit unergonomic when working with other errors (because of `!Send`)
* `sqlx` does not support the full functionality of SQLite (hooks, functions, etc)